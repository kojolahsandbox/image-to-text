<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR KK â†’ Google Sheets</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    video, canvas { width: 100%; max-width: 520px; background: #000; border-radius: 8px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; }
    .btn { padding:10px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    textarea { width:100%; min-height:120px; }
    .ok { color: #0a7c28; }
    .warn { color: #b45d00; }
    .err { color: #b00020; }
    table { border-collapse: collapse; width:100%; font-size:14px; }
    th, td { border:1px solid #ddd; padding:6px; }
    th { background:#f5f5f5; }
    .small { font-size:12px; color:#666; }
    label { font-weight: 600; }
    input[type="text"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
  </style>
  <!-- Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <h2>OCR Kartu Keluarga â†’ Spreadsheet</h2>
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn">ðŸŽ¥ Nyalakan Kamera</button>
      <button id="snapBtn"  class="btn" disabled>ðŸ“¸ Ambil Gambar & OCR</button>
      <button id="sendBtn"  class="btn" disabled>ðŸ“¤ Kirim ke Google Sheets</button>
    </div>
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="status" class="small">Status: menunggu kameraâ€¦</div>
  </div>

  <div class="card">
    <label>Endpoint Web App (Google Apps Script):</label>
    <input id="endpoint" type="text" placeholder="Tempel URL Web App kamu di sini (https://script.google.com/macros/s/....../exec)">
    <div class="small">Data akan dikirim sebagai JSON via <code>POST</code>.</div>
  </div>

  <div class="card">
    <h3>Hasil OCR (mentah)</h3>
    <textarea id="raw"></textarea>
  </div>

  <div class="card">
    <h3>Ringkasan Metadata KK</h3>
    <div id="meta"></div>
  </div>

  <div class="card">
    <h3>Tabel Anggota Keluarga (terbaca)</h3>
    <table id="anggotaTbl">
      <thead>
        <tr>
          <th>No</th><th>NIK</th><th>Nama</th><th>JK</th><th>Tempat/Tgl Lahir</th>
          <th>Agama</th><th>Pendidikan</th><th>Pekerjaan</th><th>Status Kawin</th>
          <th>Hubungan</th><th>Kewarganegaraan</th><th>Nama Ayah</th><th>Nama Ibu</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small">Catatan: parsing tabel bergantung pada kualitas scan & layout KK.</div>
  </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const statusEl = document.getElementById('status');
const rawEl = document.getElementById('raw');
const metaEl = document.getElementById('meta');
const tbody = document.querySelector('#anggotaTbl tbody');
const startBtn = document.getElementById('startBtn');
const snapBtn  = document.getElementById('snapBtn');
const sendBtn  = document.getElementById('sendBtn');
const endpointEl = document.getElementById('endpoint');

let lastParsed = null;

function setStatus(msg, cls="") {
  statusEl.textContent = "Status: " + msg;
  statusEl.className = cls || "small";
}

startBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }, audio: false
    });
    video.srcObject = stream;
    snapBtn.disabled = false;
    setStatus("kamera aktif. Arahkan ke KK, ratakan, pencahayaan cukup.");
  } catch (e) {
    setStatus("izin kamera ditolak: " + e.message, "err");
  }
};

snapBtn.onclick = async () => {
  // ambil frame dari video
  const w = video.videoWidth;
  const h = video.videoHeight;
  if (!w || !h) { setStatus("kamera belum siap.", "warn"); return; }
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);

  setStatus("OCR berjalanâ€¦ ini bisa butuh beberapa detik.");
  snapBtn.disabled = true;

  try {
    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
    const { data: { text } } = await Tesseract.recognize(
      dataURL,
      'ind+eng',  // bahasa Indonesia + Inggris
      { logger: m => { /* console.log(m); */ } }
    );
    rawEl.value = text;
    const parsed = parseKK(text);
    lastParsed = parsed;
    renderParsed(parsed);
    setStatus("OCR selesai.", "ok");
    sendBtn.disabled = false;
  } catch (e) {
    setStatus("Gagal OCR: " + e.message, "err");
  } finally {
    snapBtn.disabled = false;
  }
};

sendBtn.onclick = async () => {
  const url = endpointEl.value.trim();
  if (!url) { setStatus("Mohon isi URL Web App (Apps Script).", "warn"); return; }
  if (!lastParsed) { setStatus("Belum ada data untuk dikirim.", "warn"); return; }

  setStatus("Mengirim ke Google Sheetsâ€¦");
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(lastParsed)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const out = await res.json().catch(()=> ({}));
    setStatus("Terkirim. Respon: " + JSON.stringify(out), "ok");
  } catch (e) {
    setStatus("Gagal kirim: " + e.message, "err");
  }
};

/* ======== PARSER KK ======== */
/* Catatan:
   - KK punya variasi layout (model lama biru, model baru HVS putih + QR).
   - Strategi: ekstrak metadata atas (No KK, Nama Kepala Keluarga, Alamat, RT/RW, Kel/Desa, Kecamatan, Kab/Kota, Kode Pos, Provinsi)
     lalu parse tabel anggota baris demi baris menggunakan pola umum (NIK 16 digit, JK L/P, tgl dd-mm-yyyy/dmmyyyy).
   - Ini POC: bisa kamu sempurnakan dengan heuristik tambahan sesuai contoh KK yang kamu miliki.
*/
function parseKK(textRaw) {
  const text = normalize(textRaw);
  // Metadata
  const noKK = findFirst(text, /(no(\.|mor)?\s*kartu\s*keluarga|no\s*kk)\s*[:\-]?\s*([0-9]{8,20})/i, 2);
  const kepala = findFirst(text, /(nama\s*kepala\s*keluarga)\s*[:\-]?\s*([A-Z' .-]+)/i, 2);
  const alamat = findFirst(text, /(alamat)\s*[:\-]?\s*([A-Z0-9\/ ,.'\-]+)/i, 2);
  const rtrw = findFirst(text, /(rt\s*\/\s*rw)\s*[:\-]?\s*([0-9]{1,3}\s*\/\s*[0-9]{1,3})/i, 2);
  const kel = findFirst(text, /(kel(\.|urahan)?|desa)\s*[:\-]?\s*([A-Z0-9 .'\-]+)/i, 3);
  const kec = findFirst(text, /(kec(\.|amatan)?)\s*[:\-]?\s*([A-Z0-9 .'\-]+)/i, 3);
  const kab = findFirst(text, /(kab(\.|upaten)?|kota)\s*[:\-]?\s*([A-Z0-9 .'\-]+)/i, 3);
  const prov = findFirst(text, /(prov(\.|insi)?)\s*[:\-]?\s*([A-Z0-9 .'\-]+)/i, 3);
  const kodepos = findFirst(text, /(kode\s*pos)\s*[:\-]?\s*([0-9]{5})/i, 2);

  // Ekstrak baris anggota
  const anggota = parseAnggota(text);

  return {
    sumber: "ocr-kk-webapp",
    timestamp: new Date().toISOString(),
    meta: { noKK, kepala, alamat, rtrw, kel, kec, kab, prov, kodepos },
    anggota // array of rows
  };
}

function normalize(s) {
  return s
    .replace(/\r/g, '\n')
    .replace(/[^\S\n]+/g, ' ')
    .replace(/[â€“â€”]/g, '-')
    .replace(/[\t]+/g, ' ')
    .replace(/\u00A0/g, ' ')
    .toUpperCase();
}

function findFirst(text, regex, groupIdx) {
  const m = text.match(regex);
  return m ? m[groupIdx].trim().replace(/\s+/g,' ') : "";
}

function parseAnggota(text) {
  // Pisah per baris dan buang baris kosong
  const lines = text.split('\n').map(s => s.trim()).filter(Boolean);

  // Cari indeks awal tabel setelah header kolom umum
  const headerIdx = lines.findIndex(line =>
    /NIK/.test(line) && /NAMA/.test(line) && /(JENIS KELAMIN|JK)/.test(line)
  );

  const hasil = [];
  if (headerIdx === -1) {
    // fallback: cari semua baris yang mengandung NIK 16 digit dan bangun record simpel
    const nikRegex = /\b\d{16}\b/;
    lines.forEach((l, i) => {
      const nik = (l.match(nikRegex) || [])[0] || "";
      if (nik) {
        // Nama biasanya ada sebelum/sekitar baris NIK
        const nama = lines[i-1] && !/\d{16}/.test(lines[i-1]) ? lines[i-1] : "";
        hasil.push({ no: String(hasil.length+1), nik, nama, jk:"", ttl:"", agama:"", pend:"", pek:"", status:"", hubungan:"", wn:"", ayah:"", ibu:"" });
      }
    });
    return hasil;
  }

  // Ambil baris setelah header sampai sebelum bagian tanda tangan / catatan
  const body = lines.slice(headerIdx + 1);

  // RegEx bantu
  const nikR = /\b\d{16}\b/;
  const tglR = /\b(\d{1,2}[-\/\.]\d{1,2}[-\/\.]\d{2,4}|\d{8})\b/; // 01-01-2020 atau 01012020
  const jkR  = /\b(LAKI[- ]?LAKI|PEREMPUAN|L|P)\b/;

  let rowNo = 1;
  for (let i = 0; i < body.length; i++) {
    const line = body[i];

    // deteksi akhir tabel
    if (/KEPALA DINAS|KADIS|QR|TANDA TANGAN|MENGETAHUI/.test(line)) break;

    // cara 1: baris kaya data
    if (nikR.test(line)) {
      const nik = (line.match(nikR) || [])[0] || "";
      // heuristik nama = teks sebelum NIK
      const beforeNik = line.split(nik)[0].trim();
      let nama = beforeNik.replace(/^\d+\s+/, '').trim();
      if (!nama && body[i-1]) nama = body[i-1]; // fallback

      // JK, TTL, dll bisa berada di baris ini atau berikutnya
      let buf = line + " " + (body[i+1]||"") + " " + (body[i+2]||"");
      const jkM = buf.match(jkR);
      const ttlM = buf.match(tglR);

      // ekstrak kolom lain (best-effort)
      const agama = pickFirst(buf, ["ISLAM","KRISTEN","KATHOLIK","HINDU","BUDDHA","KONGHUCU","PROTESTAN"]);
      const hubungan = pickFirst(buf, ["KEPALA KELUARGA","ISTRI","SUAMI","ANAK","MENANTU","CUCU","ORANG TUA","MERTUA","FAMILI"]);
      const status = pickFirst(buf, ["BELUM KAWIN","KAWIN","CERAI HIDUP","CERAI MATI"]);
      const wn = pickFirst(buf, ["WNI","WNA"]);

      hasil.push({
        no: String(rowNo++),
        nik,
        nama: clean(nama),
        jk: jkM ? mapJK(jkM[0]) : "",
        ttl: ttlM ? ttlM[0] : "",
        agama,
        pend: pickFirst(buf, ["SD","SMP","SMA","SMK","D1","D2","D3","D4","S1","S2","S3"]),
        pek: pickFirst(buf, ["PELAJAR","MAHASISWA","KARYAWAN","WIRASWASTA","PNS","TNI","POLRI","IBU RUMAH TANGGA","PETANI","GURU","DOKTER","PERAWAT","BURUH"]),
        status,
        hubungan,
        wn,
        ayah: "", ibu: ""
      });
    }
  }
  return hasil;
}

function pickFirst(text, arr) {
  for (const a of arr) {
    const r = new RegExp("\\b" + a + "\\b", "i");
    if (r.test(text)) return a.toUpperCase();
  }
  return "";
}
function clean(s){ return (s||"").replace(/\s+/g,' ').trim(); }
function mapJK(s){ s = s.toUpperCase(); if (s.startsWith('L')) return 'L'; if (s.startsWith('P')) return 'P'; if (s.includes('PEREM')) return 'P'; return 'L'; }

function renderParsed(data) {
  const m = data.meta;
  metaEl.innerHTML = `
    <table>
      <tr><th>No KK</th><td>${m.noKK||'-'}</td></tr>
      <tr><th>Nama Kepala Keluarga</th><td>${m.kepala||'-'}</td></tr>
      <tr><th>Alamat</th><td>${m.alamat||'-'}</td></tr>
      <tr><th>RT/RW</th><td>${m.rtrw||'-'}</td></tr>
      <tr><th>Kel/Desa</th><td>${m.kel||'-'}</td></tr>
      <tr><th>Kecamatan</th><td>${m.kec||'-'}</td></tr>
      <tr><th>Kab/Kota</th><td>${m.kab||'-'}</td></tr>
      <tr><th>Provinsi</th><td>${m.prov||'-'}</td></tr>
      <tr><th>Kode Pos</th><td>${m.kodepos||'-'}</td></tr>
    </table>
  `;

  tbody.innerHTML = "";
  for (const r of data.anggota) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.no}</td><td>${r.nik}</td><td>${r.nama}</td><td>${r.jk}</td>
      <td>${r.ttl}</td><td>${r.agama}</td><td>${r.pend}</td><td>${r.pek}</td>
      <td>${r.status}</td><td>${r.hubungan}</td><td>${r.wn}</td><td>${r.ayah}</td><td>${r.ibu}</td>
    `;
    tbody.appendChild(tr);
  }
}
</script>
</body>
</html>
